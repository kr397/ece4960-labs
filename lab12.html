<!DOCTYPE html>
<html lang="en">
    <head>
 
        <title>ECE 4960 Lab 12 - Krithik Ranjan</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="main.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

        <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap" rel="stylesheet">

        <link href="prism.css" rel="stylesheet" />

        <!--
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        -->

    </head>
    <body>
        <!--
        <nav class="navbar navbar-expand-md">
            
            <a class="navbar-brand">ECE 4960</a>
            <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#main-navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="main-navigation">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">COURSE WEBSITE</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">CODE REPO</a>
                    </li>
                </ul>
            </div>
        </nav>
        -->

        <div class="container-fluid projects">
            <div class="row align-items-center">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <h2 class="section-title">LAB 12<br>Localization (Real)</h2>
                    <p class="section-text">Lab 12 was an exciting lab, where we implemented Bayes filter-based localization on the actual robot. Just like in Lab 11, where the simulator robot performed a trajectory and localized at every step, this lab was the first step of doing that on the robot in which we only executed the update step in the Bayes filter at different poses in the lab and observed the robot’s perception of its location. This was an interesting lab, where we saw for the first time the robot performing an autonomous task without much tuning or control required (like in PID). </p>
                    <p class="section-text">In this lab, I worked with Aryaa Pai (avp34) and Aparajito Saha (as2537). We used my robot and the Artemis codebase from previous labs, and Aryaa’s and Apu’s Jupyter notebooks to control the robot and perform the localization on the system. </p>

                    <h4 class="section-header">Localization Module</h4>
                    <p class="section-text">For this lab, the course staff has provided us with a fully functional and optimized Bayes filter implementation in the form of a <code class="inline-code">Localization</code> class along with wrapper classes <code class="inline-code">VirtualRobot</code> and <code class="inline-code">RealRobot</code> for handling the robot with the localization module. We have also been given a complete Jupyter notebook <code class="inline-code">lab12_sim.ipynb</code> that performs a trajectory with the virtual notebook and localizes at each step, similar to Lab 11. The result of one such run is shown below, where the green line shows the actual movement of the robot (ground truth), the red line represents the robot’s perception based on its odometry model, and the blue line represents the robot’s perception based on Bayes filter localization. The result is very similar to that in Lab 11, where the robot’s belief closely matches the actual movement in most portions of the trajectory. </p>
                    <figure>
                        <img src="images/lab12/loc_sim.png" width="80%">
                        <figcaption>Figure: Localization performed on the simulator</figcaption>
                    </figure>

                    <h4 class="section-header">Localization on the Real Robot</h4>
                    <p class="section-text">In order to perform localization on the real robot, we needed to complete the provided <code class="inline-code">lab12_real.ipynb</code> Jupyter notebook with the implementation of the <code class="inline-code">RealRobot</code> class. This class is used to interface with our robot through Bluetooth commands and prepares the data to be used for the update step in the Bayes filter, that is, the sensor model measurements taken around the current pose of the robot. </p>
                    <p class="section-text">The implementation of the <code class="inline-code">perform_observation_loop()</code> function is shown below, which is called by the localization class in the update step for the robot to rotate on it’s spot and obtain 18 distance sensor measurements in the range 0° to 360°. In our implementation, this function sends the robot a command <code class="inline-code">CMD.TURN_RECORD</code> 18 times, which causes the robot to take a distance measurement, and turn by a preconfigured angle of 20° each times. Once the loop has been performed and the data collected, the function obtains all the measurement values to Jupyter using the <code class="inline-code">CMD.GET_DATA</code> command like in previous labs. We also added some helper functions to the class for the callback function and for PID tuning. The video below shows the robot performing one observation loop.</p>

                    <figure>
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/tQwt-iIhf68?start=7" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    </figure>

                    <p class="section-text">The obtained sensor values array needs to be modified to match the format used in localization, which is sensor readings at 20° increments like 0°, 20°, 40° counter-clockwise. Since Lab 6, the turning PID controller in my robot has been implemented such that it turns the robot clockwise for a positive target angle (corresponding to the placement of the IMU on the robot). Therefore, instead of re-orienting and retuning the controller on the robot, we chose to turn the robot clockwise to perform the observation loop – resulting in sensor data at 0°, 340°, 320° … – which is transformed thereafter. The sensor data array is reversed, and the last element (at 0°) put in the beginning to result in the final <code class="inline-code">sensor_ranges</code> vector returned by the function. </p>

                    <pre><code class="language-python">def perform_observation_loop(self, rot_vel=120):
    """Perform the observation loop behavior on the real robot, where the robot does  
    a 360 degree turn in place while collecting equidistant (in the angular space) sensor
    readings, with the first sensor reading taken at the robot's current heading. 
    The number of sensor readings depends on "observations_count"(=18) defined in world.yaml.
    
    Keyword arguments:
        rot_vel -- (Optional) Angular Velocity for loop (degrees/second)
                    Do not remove this parameter from the function definition, even if you don't use it.
    Returns:
        sensor_ranges   -- A column numpy array of the range values (meters)
        sensor_bearings -- A column numpy array of the bearings at which the sensor readings were taken (degrees)
                            The bearing values are not used in the Localization module, so you may return a empty numpy array
    """
    # Send commands to execute loop and record data 
    for i in range(18):
        ble.send_command(CMD.TURN_RECORD, "")

        time.sleep(1)

    # Send command to obtain data -- stored in self.artemis_data
    asyncio.run(self.get_data("0"))
    
    # Transform the sensor data array to match the format of localization 
    self.artemis_data.reverse()
    self.artemis_data = [self.artemis_data[-1]] + self.artemis_data[:-1]
    sensor_ranges = np.array(self.artemis_data)[np.newaxis].T

    return sensor_ranges, np.empty_like(sensor_ranges)</code></pre><br>

                    <h4 class="section-header">Results</h4>
                    <p class="section-text">Once we had implemented and tested the <code class="inline-code">RealRobot</code> class, we could perform Bayes filter localization at the five designated markers (including the origin) in the lab and observe the robot’s perceived pose. In the update step, the localization module compares the obtained sensor ranges with all possible sensor ranges at every grid cell <code class="inline-code">(x, y, θ)</code> to estimate the current pose of the robot, or the belief. The table below shows the plot of the observation loop measurements and the results of the update step at each of the markers. </p>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <h5 class="table-header">Marker</h4>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <h5 class="table-header">Observation Data</h4>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <h5 class="table-header">Update Step</h4>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <p class="section-text">(0 ft, 0 ft, 0°)</p>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <img src="images/lab12/obs_0_0.png" width="100%">
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <pre><code class="language-">Update time :0.003 s 
Bel index   :(5, 4, 8)
Prob        :0.9999999
Belief      :(0.0m, 0.0m , -10.0) 
                or (0 ft, 0 ft, -10°)</code></pre>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <p class="section-text">(0 ft, 3 ft, 0°)</p>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <img src="images/lab12/obs_0_3.png" width="100%">
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <pre><code class="language-">Update time :0.003 s 
Bel index   :(5, 7, 8)
Prob        :1.0
Belief      :(0.0m, 0.914m , -10.0) 
                or (0ft, 3ft, -10°)</code></pre>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <p class="section-text">(5 ft, 3 ft, 0°)</p>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <img src="images/lab12/obs_5_3.png" width="100%">
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <pre><code class="language-">Update time :0.003 s 
Bel index   :(10, 7, 8)
Prob        :0.9999994
Belief      :(1.524m, 0.914m , -10.0) 
                or (5ft, 3ft, -10°)</code></pre>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <p class="section-text">(5 ft, -3 ft, 0°)</p>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <img src="images/lab12/obs_5_-3.png" width="100%">
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <pre><code class="language-">Update time :0.002 s 
Bel index   :(10, 1, 8)
Prob        :0.9999999
Belief      :(1.524m, -0.914m , -10.0) 
                or (5ft, -3ft, -10°)</code></pre>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <p class="section-text">(-3 ft, -2 ft, 0°)</p>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <img src="images/lab12/obs_-3_-2.png" width="100%">
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <pre><code class="language-">Update time :0.003 s 
Bel index   :(2, 2, 8)
Prob        :0.9999999
Belief      :(-0.914m, -0.610m, -10.0) 
                or (-3ft, -2ft, -10°)</code></pre>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-2 col-md-2 col-sm-2">
                    <p class="section-text">(5 ft, -3 ft, 0°) <i>Incorrect</i></p>
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <img src="images/lab12/obs_5_-3_inc.png" width="100%">
                </div>
                <div class="col-lg-5 col-md-5 col-sm-5">
                    <pre><code class="language-">Update time :0.002 s 
Bel index   :(8, 0, 6)
Prob        :0.8859641
Belief      :(0.914m, -1.219m , -50.0) 
                or (3ft, -4ft, -50°)</code></pre>
                </div>
            </div>
            <div class="row align-items-center">
                <div class="col-lg-12 col-md-12 col-sm-12">
                    <p class="section-text">As we can see in the table and the cumulative plot below, the robot is able to correctly localize at all five of the markers, even when the observation data doesn't perfectly match the boundaries of the room, that too with a very high certainty (probability almost 1.0). Frankly, this accuracy of this system took us by surprise as well, and we performed the localization multiple times on some of the markers to achieve the same result almost always. Seems like the Bayes filter update step and the sensor model of our robot work much better than we expected. The only error we saw were while localizing at (5 ft, 3 ft, 0°) as shown by the last entry in the table. After localizing a few times at this marker, we observed that the robot predicts correctly and incorrectly fairly equal number of times. The reason why the robot's incorrect belief at these locations is such is inexplicable, except for the fact that this is a marker neighboring a corner and the robot could potentially mistake itself to be in any one of the corners in the room. We plan to further test around this marker in the next lab and come up with a strategy to avoid significant errors in mapping due to this.</p>
                    <p class="section-text">Another notable observation is that while the robot correctly localizes in the X and Y dimensions for all the markers, the angle belief is always -10° instead of the expected 0°. This is because of how the localization module and the grid model is structured in the lab. After talking with Vivek about this, we know that the angle space of 0° to 360° is divided into 18 subranges of the form 0° - 20°, 20° - 40°, and so on; however, these subranges are discretized with the value of their center angle resulting in the angle range being -30°, -10°, 10°, 30° etc. So, if the robot is at 0° angular pose, the result of the localization can only be either -10° or 10° because 0° doesn't exist in the angle space. For the next lab involving mapping along with localization, we may modify this to output the correct angle so that the robot movement doesn't cause drift inaccuracies.</p>

                    <figure>
                        <img src="images/lab12/final.png" width="80%">
                        <figcaption>Figure: Complete plot with positions of the markers and robot's belief at the markers</figcaption>
                    </figure>

                    <p class="section-text">This was an exciting lab and I'm (astonishingly) happy with the results of the localization. I'm looking forward to further upgrading this model to move the robot through a given trajectory using mapping and localization.</p>
                </div>
            </div>
        
        </div>

        <footer class="footer mt-auto py-3">
            <div class="container">
                <h5><a href="index.html">< home</a> | <a href="https://cei-lab.github.io/ECE4960-2022/Lab12.html">handout ></a></h5>
                <p><a href="mailto:kr397@cornell.edu">KR397[AT]CORNELL[DOT]EDU</a></p>
            </div>
        </footer>  
        
        <script src="prism.js"></script>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    </body>
    
</html>
